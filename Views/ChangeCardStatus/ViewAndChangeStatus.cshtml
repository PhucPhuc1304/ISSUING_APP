@using ISSUING_APP.Models;
@{
    ViewBag.Title = "ViewAndRenewal";
    List<CardInfo>
    cardRelates = ViewBag.ListCards;
}

@*<link href="/Scripts/Vendor/dataTables/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="/Scripts/Vendor/dataTables/css/fixedColumns.dataTables.min.css" rel="stylesheet" />
    <script src="/Scripts/Vendor/dataTables/js/jquery.dataTables.min.js"></script>
    <script src="/Scripts/Vendor/dataTables/js/dataTables.bootstrap.min.js"></script>
    <script src="/Scripts/Vendor/dataTables/js/dataTables.fixedHeader.min.js"></script>
    <script src="/Scripts/Vendor/dataTables/js/dataTables.fixedColumns.min.js"></script>
    <link href="/Scripts/Vendor/SelectOption/css/jquery-customselect-1.9.1.css" rel="stylesheet" />
    <script src="/Scripts/Vendor/SelectOption/js/jquery-customselect-1.9.1.min.js"></script>

    <link href="/Scripts/Vendor/Main/css/Style.css" rel="stylesheet" />
    <script src="/Scripts/Vendor/Main/js/common.js"></script>*@

@model ISSUING_APP.Models.CardInfo

@*<div class="body-content">
    <div class="book" style="padding:0px;">
        <div class="page" style="margin:0px;">
            <div class="subpage">
*@
    <div class="container section-01 section-03">
        <div class="row subsection-title" style="padding: 5px;">
            <div class="col-lg-6 col-md-6" style="color: #b02c26;">THÔNG TIN CHỦ THẺ: Trạng thái thẻ - @Model.CONTR_STATUS_NAME </div>
        </div>
        <input type="hidden" value="@Model.CONTR_STATUS_NAME" id="txtP_CONTR_STATUS_NAME" />
        <div class="row">
            <div class="col-sm-2 norwap"> Tên khách hàng </div> <div class="col-sm-4"> <label ID="txtCLIENT_SHORT_NAME" text="@Model.CLIENT_SHORT_NAME" class="form-control" style="width:100%">@Model.CLIENT_SHORT_NAME</label></div>
            <div class="col-sm-2 norwap"> CMND/Passport </div>
            <div class="col-sm-4">
                <label ID="txtREG_NUMBER" text="@Model.REG_NUMBER" class="form-control" style="width:100%">@Model.REG_NUMBER</label>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2 norwap"> Ngày sinh </div> <div class="col-sm-4">
                <label ID="txtCLIENT_BIRTH_DATE" text="@Model.CLIENT_BIRTH_DATE" class="form-control" style="width:100%">
                    @((Model.CLIENT_BIRTH_DATE == "") ? "" : Convert.ToDateTime(Model.CLIENT_BIRTH_DATE).ToString("dd/MM/yyyy"))
                </label>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2 norwap"> Mã CIF </div> <div class="col-sm-4"> <label ID="txtCLIENT_NUMBER" text="@Model.CLIENT_NUMBER" class="form-control" style="width:100%">@Model.CLIENT_NUMBER</label></div>
            <div class="col-sm-2 norwap"> Ngày mở CIF</div> <div class="col-sm-4">
                <label ID="txtCLIENT_OPEN_DATE" class="form-control" style="width:100%">
                    @((Model.CLIENT_OPEN_DATE == "") ? "" : Convert.ToDateTime(Model.CLIENT_OPEN_DATE).ToString("dd/MM/yyyy"))
                </label>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2 norwap"> Điện thoại  </div> <div class="col-sm-4">
                <label ID="txtCLIENT_PHONE" text="@Model.CLIENT_PHONE" class="form-control" style="width:100%">@Model.CLIENT_PHONE</label>

            </div>
            <div class="col-sm-2 norwap"> ĐT Nhà </div> <div class="col-sm-4"> <label ID="txtCLIENT_PHONE_H" text="@Model.CLIENT_PHONE_H" class="form-control" style="width:100%">@Model.CLIENT_PHONE_H</label></div>

        </div>

        <div class="row">
            <div class="col-sm-2 norwap"> ĐT di động </div> <div class="col-sm-4"> <label ID="txtCLIENT_PHONE_M" text="@Model.CLIENT_PHONE_M" class="form-control" style="width:100%">@Model.CLIENT_PHONE_M</label></div>
            <div class="col-sm-2 norwap"> Email </div> <div class="col-sm-4"> <label ID="txtCLIENT_EMAIL" text="@Model.CLIENT_EMAIL" class="form-control" style="width:100%">@Model.CLIENT_EMAIL</label></div>

        </div>

        <div class="row">
            <div class="col-sm-2 norwap"> Địa chỉ KH </div> <div class="col-sm-10"> <label ID="txtCLIENT_ADDRESS_LINE" text="@Model.CLIENT_ADDRESS_LINE" class="form-control" style="width:100%">@Model.CLIENT_ADDRESS_LINE</label></div>
            <div class="col-sm-2 norwap" style="display:none"> ID thẻ </div> <div class="col-sm-4" style="display:none"> <label ID="txtACNT_CONTRACT_ID" text="@Model.ACNT_CONTRACT_ID" class="form-control" style="width:100%">@Model.ACNT_CONTRACT_ID</label></div>
        </div>

        <div class="row">
            <div class="col-sm-2 norwap"> Số thẻ </div> <div class="col-sm-4"> <label ID="txtCONTRACT_NUMBER" text="@Model.CONTRACT_NUMBER" class="form-control" style="width:100%">@CShared.replaceToXXX(Model.CONTRACT_NUMBER)</label></div>
            <div class="col-sm-2 norwap"> Tên thẻ </div> <div class="col-sm-4"> <label ID="txtCONTRACT_NAME" text="@Model.CONTRACT_NAME" class="form-control" style="width:100%">@Model.CONTRACT_NAME</label></div>

        </div>

        <div class="row">
            <div class="col-sm-2 norwap"> Loại thẻ </div> <div class="col-sm-4"> <label ID="txtCONTR_TYPE_NAME" text="@Model.CONTR_TYPE_NAME" class="form-control" style="width:100%">@Model.CONTR_TYPE_NAME</label></div>
            <div class="col-sm-2 norwap"> Thẻ chính | thẻ phụ </div> <div class="col-sm-4"> <label ID="txtINTERVAL_TYPE" text="@Model.INTERVAL_TYPE" class="form-control" style="width:100%">@Model.INTERVAL_TYPE</label></div>

        </div>

        <div class="row">
            <div class="col-sm-2 norwap"> Trạng thái thẻ </div> <div class="col-sm-4"> <label ID="txtCONTR_STATUS" text="@Model.CONTR_STATUS_NAME" class="form-control" style="width:100%">@Model.CONTR_STATUS_CODE - @Model.CONTR_STATUS_NAME</label></div>
            <div class="col-sm-2 norwap"> Ngày mở thẻ </div> <div class="col-sm-4">
                <label ID="txtDATE_OPEN" text="@Model.DATE_OPEN" class="form-control" style="width:100%">
                    @((Model.DATE_OPEN == "") ? "" : Convert.ToDateTime(Model.DATE_OPEN).ToString("dd/MM/yyyy"))
                </label>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-2 norwap"> Đã hết hạn </div> <div class="col-sm-4"> <label ID="txtDate_EXPIRE" text="@Model.DATE_EXPIRE" class="form-control" style="width:100%">@Model.DATE_EXPIRE</label></div>
            <div class="col-sm-2 norwap"> Trạng thái sản phẩm </div> <div class="col-sm-4"> <label ID="txtPRODUCTION_STATUS" text="@Model.CONTR_STATUS" class="form-control" style="width:100%">@Model.CONTR_STATUS</label></div>
        </div>
        <div class="row">
            <div class="col-sm-2 norwap"> Tên Sản phẩm </div> <div class="col-sm-4"> <label ID="txtPRODUCT_NAME" text="@Model.PRODUCT_NAME" class="form-control" style="width:100%">@Model.PRODUCT_NAME</label></div>

            <div class="col-sm-2 norwap"> Tên ĐV tạo thẻ </div> <div class="col-sm-4"> <label ID="txtCARD_BRANCH_NAME" text="@Model.CARD_BRANCH_NAME" class="form-control" style="width:100%">@Model.CARD_BRANCH_NAME</label></div>
        </div>
        <div class="row">
            <div class="col-sm-2 norwap">Số hợp đồng </div> <div class="col-sm-4"> <label ID="txtLOC_ACCT" text="@Model.LOC_ACCT" class="form-control" style="width:100%;font-weight: bold;">@Model.LOC_ACCT</label></div>
            <div class="col-sm-2 norwap"> Tình trạng hợp đồng</div> <div class="col-sm-4"> <label ID="txtLOC_ACCT_STATUS" text="@Model.LOC_ACCT_STATUS" class="form-control" style="width:100%;font-weight: bold">@Model.LOC_ACCT_STATUS</label></div>
            <input type="hidden" value="@Model.CARD_PRODUCT_CODE" id="txtCARD_PRODUCT_CODE" />
            <input type="hidden" value="@Model.CONTR_STATUS_ACCT_CODE" id="txtCONTR_STATUS_ACCT_CODE" />
        </div>
        @if (Model.CONTR_STATUS_CODE == "C053" && !string.IsNullOrEmpty(Model.LOCK_FROM))
        {
            <div class="row">
                <div class="col-sm-2 norwap">Kênh khóa thẻ</div> <div class="col-sm-4"> <label ID="txtLOC_FROM" text="@Model.LOCK_FROM" class="form-control" style="width:100%;font-weight: bold;">@Model.LOCK_FROM</label></div>
                <div class="col-sm-2 norwap">Khóa đến ngày</div> <div class="col-sm-4"> <label ID="txtLOC_DATE" text="@Model.LOCK_DATE" class="form-control" style="width:100%;font-weight: bold">@Model.LOCK_DATE</label></div>
            </div>
        }

        @if (Model.CARD_PRODUCT_CODE.Contains("_CR_"))
        {
            <div class="row">
                <div class="col-sm-2 norwap">Dư nợ hợp đồng: </div>
                <div class="col-sm-4"><label ID="txtLOC_ACCT" text="@Model.LOC_ACCT" class="form-control" style="width:100%;font-weight: bold">@CShared.FormatNumber(ViewBag.Debt)</label></div>
                <input type="hidden" id="debt" value="@ViewBag.Debt" />
            </div>
        }
    </div>
@*Leln2 add 25/12/2019*@
@if (cardRelates != null && cardRelates.Count > 0)
{
    <div class="container section-01 section-03">
        <div class="row subsection-title" style="padding: 5px;">
            <div class="col-lg-6 col-md-6" style="color: #b02c26;">Danh sách thẻ liên quan</div>
        </div>
        <div class="row" style="padding: 5px;">
            <table id="tbDataList" class="table table-striped table-bordered" cellspacing="0" style="width:1000px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Số thẻ</th>
                        <th>Tên chủ thẻ</th>
                        <th>Chính/Phụ</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int stt = 0;}
                    @foreach (var item in cardRelates)
                    {
                        stt = stt + 1;
                        <tr>
                            <td>@stt</td>
                            <td>@CShared.replaceToXXX(item.CONTRACT_NUMBER)</td>
                            <td>@item.CLIENT_SHORT_NAME</td>
                            <td>@item.INTERVAL_TYPE</td>
                            <td>@item.CONTR_STATUS</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
                        }
<div class="container section-01 section-02">
    <div class="row subsection-title" style="padding: 5px;">
        <div class="col-lg-6 col-md-6" style="color: #b02c26;">THÔNG TIN THAY ĐỔI TRẠNG THÁI THẺ</div>
    </div>
    <div class="row" style="padding: 5px;">
        <div class="col-sm-12" style="color: red; font-weight: bold; text-decoration: underline; font-size: 15px;">LƯU Ý: </div>
        <div class="col-sm-12" style="color: red; font-weight: bold;">- Trường hợp khách hàng bị mất thẻ thì phải khỏa thẻ với lý do "Thẻ thât lạc/mất cắp". Hệ thống không cho mở khóa với thẻ bị khóa do thất lạc/mất cắp</div>
        <div class="col-sm-12" style="color: red; font-weight: bold;">- Trường hợp khách hàng yêu cầu tạm khóa và có thể mở khóa để tiếp tục sử dụng thì chọn lý do "Khóa thẻ tạm thời"</div>
    </div>
    <div class="row" style="padding: 5px;">
        <div class="col-sm-4"> Trạng thái muốn thay đổi: </div>
        <div class="col-sm-8">
            <select id="ddlP_LOCK_TYPE" class="form-control" style="width: 100%" onchange="changeComboBox();">
                <option value="">Chọn trạng thái</option>
                @{
                    SESSION_PARA oPara = CShared.getSession();
                    string role;
                    try
                    {
                        role = oPara.oAccount.Roles;
                    }
                    catch (Exception)
                    {
                        role = "";
                    }

                }
                @if (Model.CONTR_STATUS_CODE == "C00" || Model.CONTR_STATUS_CODE == "MC001")
                {
                    <option value="C053">Khóa thẻ tạm thời</option>
                    if (role.Contains("billpay-input"))
                    {
                        <option value="C054">Hủy thẻ</option>
                    }
                }
                @if (Model.CONTR_STATUS_CODE == "C00" || Model.CONTR_STATUS_CODE == "MC001" || Model.CONTR_STATUS_CODE == "C053")
                {
                    <option value="C41">Thẻ bị thất lạc/mất cắp</option>
                    <option value="C59">Thẻ nghi ngờ bị gian lận</option>
                }
                @if (Model.CONTR_STATUS_CODE == "C053" || Model.CONTR_STATUS_CODE == "C62" || Model.CONTR_STATUS_CODE == "C59" || Model.CONTR_STATUS_CODE == "MC054" || Model.CONTR_STATUS_CODE == "MC002")
                {

                    if (role.Contains("billpay-input"))
                    {
                        <option value="C00">Mở khóa thẻ</option>
                    }
                }
                @if (Model.CONTR_STATUS_CODE == "C053")
                {

                    //if (role.Contains("billpay-input"))
                    //{
                    <option value="C053">Cập nhật thời gian khóa</option>
                    //}
                }
                @if (Model.CONTR_STATUS_CODE == "C053" || Model.CONTR_STATUS_CODE == "C62" || Model.CONTR_STATUS_CODE == "C59" || Model.CONTR_STATUS_CODE == "C54" || Model.CONTR_STATUS_CODE == "MC054" || Model.CONTR_STATUS_CODE == "MC002" || Model.CONTR_STATUS_CODE == "C41")
                {
                    if (role.Contains("billpay-input"))
                    {
                        <option value="C054">Hủy thẻ</option>
                    }
                }
                @if (Model.CONTR_STATUS_CODE == "C055")
                {
                    if (role.Contains("ttt") || Model.CARD_BRANCH_NO.Contains(oPara.oAccount.Branch))
                    {
                        <option value="C00">Mở khóa thẻ</option>
                    }
                }
            </select>
            <input type="hidden" id="LOCK_TYPE_OLD" value="@Model.CONTR_STATUS_CODE" />
        </div>
    </div>
    <div id="divP_LOCK_TIME" class="row" style="display: none; padding: 5px;">
        @*<div class="col-sm-2"> Từ ngày </div>
        <div class="col-sm-4">
            <div class="datepicker-wrap">
                <div class="input-group" style="display: inherit;">
                    <input type="text" id="txtP_LOCK_FROM" size="10" style="width:80%" class="form-control" value="20/03/2019">
                    <span class="input-group-btn" style="top: 0px;left: 0px;">
                        <button class="btn btn-default colorRed" type="button" id="btnFromDate" style="width:42px;height:30px;"><i class="glyphicon glyphicon-calendar" aria-hidden="true"></i></button>
                    </span>
                </div>
            </div>
        </div>*@
        <div class="col-sm-4"> Khóa đến ngày </div>
        <div class="col-sm-4">
            <div class="input-group" style="display: inherit;">
                <input type="text" id="txtP_LOCK_TO" size="10" style="width:80%" class="form-control" value="20/03/2019">
                <span class="input-group-btn" style="top: 0px;left: 0px;">
                    <button class="btn btn-default colorRed" type="button" id="btnToDate" style="width:42px;height:30px;"><i class="glyphicon glyphicon-calendar" aria-hidden="true"></i></button>
                </span>
            </div>
        </div>
    </div>
@if (Model.CARD_PRODUCT_CODE.Substring(Model.CARD_PRODUCT_CODE.Length - 2) != "_S" && Model.CARD_PRODUCT_CODE.Contains("_CR_"))
    {
        <div id="divClose" class="row" style="display: none; padding: 5px;">
            <div class="col-sm-3"> Hủy hợp đồng (Issuing Contract): </div>
            <div class="col-sm-1">
                <div class="datepicker-wrap">
                    <div class="input-group" style="display: inherit;">
                        <input type="checkbox" id="txtEnableClose" style="width:80%" class="form-control" @(Model.CARD_PRODUCT_CODE.Contains("_CR_CPRT_")?"":"disabled checked") >
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <span style="color: red; font-weight: bold;"> Kiểm tra dư nợ hợp đồng và hủy tất cả các thẻ khác cùng hợp đồng trước khi thực hiện hủy</span>
            </div>
        </div>
    }

    <input type="hidden" value="@Model.CARD_PRODUCT_CODE" id="cardTypeCode" />

    <div class="row" style="padding: 5px;">
        <div class="col-sm-4"> Lý do </div>
        <div class="col-sm-8">
            <input id="txtP_REASON" class="form-control" style="width:100%;" />
        </div>
    </div>
    <div class="row" style="padding: 5px;">
        <div class="col-sm-4"> File đính kèm </div>
        <div class="col-sm-6">
            <input type="file" id="fileUpload" name="file" style="width:100%" accept="image/jpeg,image/jpg,application/pdf" />
        </div>
        <div class="col-sm-2">
            <input type="button" id="btnUpload" value="Upload" onclick="doUpload()" />
        </div>
    </div>
    <div class="row" style="padding: 5px;">
        <div class="col-sm-12 text-center">
            <button type="button" class="btn btn-primary" style="padding:0px 20px;" id="searchData" onclick="SaveAction();">Thay đổi</button>
        </div>
    </div>
    <div class="row" style="padding: 5px;">
        <div class="col-sm-10">&nbsp;</div>
    </div>
</div>

@*
            </div>
        </div>
    </div>*@


<script type="text/javascript">
    $(document).ready(function () {
        var fdate = $("#txtP_LOCK_FROM").datepicker({ dateFormat: 'dd/mm/yy', changeMonth: true, changeYear: true });
        var tdate = $("#txtP_LOCK_TO").datepicker({ dateFormat: 'dd/mm/yy', changeMonth: true, changeYear: true });

        var now = new Date();

        fdate.datepicker('setDate', now);
        tdate.datepicker('setDate', now);

        $("#btnFromDate").click(function () { $("#txtP_LOCK_FROM").datepicker("show"); });
        $("#btnToDate").click(function () { $("#txtP_LOCK_TO").datepicker("show"); });
        $("#txtP_REASON").keyup(function () {
            var temp = $(this).val();
            var value = removeAccents(temp);
            $(this).val(value);
        });
        InitDataTable();
    });
    function InitDataTable() {
        var t = $('#tbDataList').DataTable({
            scrollY: 400,
            scrollX: true,
            scrollCollapse: true,
            paging: false,
            "order": [],
            "columnDefs": [{
                "targets": 'no-sort',
                "orderable": false
            }],
            "columns": [
                { "width": "60px", "orderable": false },
                { "width": "120px", "orderable": "true" },
                { "width": "120px", "type": "html-num-fmt" },
                { "width": "120px", "type": "html-num-fmt" },
                { "width": "110px", "type": "html-num-fmt" },
            ],
            fixedColumns: { leftColumns: 4 },
        });
    };
    function removeAccents(text) {
        if (text == '')
            return;
        text = text.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
        text = text.replace(/đ/g, "d");
        text = text.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
        text = text.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
        text = text.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
        text = text.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
        text = text.replace(/ì|í|ị|ỉ|ĩ/g, "i");
        text = text.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
        text = text.replace(/Đ/g, "D");
        text = text.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
        text = text.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
        text = text.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
        text = text.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
        text = text.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");

        str = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ()-_+?:}{/.,' ";
        for (i = 0; i < text.length; i++) {
            if (text.length >= 1 && str.indexOf(text.substr(i, 1)) == -1) {
                text = text.replace(text.substr(i, 1), '');
                i = 0;
            }
        }


        return text.toUpperCase();
    }

        function changeComboBox() {
        var value = $('#ddlP_LOCK_TYPE').val();
        if (value == "C053") {
            $("#divP_LOCK_TIME").show();
            //$("#divP_LOCK_TIME").css("display", "block");
        } else {
            $("#divP_LOCK_TIME").hide();
        }
        if (value == "C054") {
            $("#divClose").show();
            //$("#divp_lock_time").css("display", "block");
        } else {
            $("#divClose").hide();
        }

    };
</script>
